---
- name: Detect the virtualisation engine
  when: libvirt_vm_engine is none or libvirt_vm_engine | length == 0
  block:
    - name: Load the kvm kernel module
      community.general.modprobe:
        name: kvm
      become: true
      failed_when: false

    - name: Check for the KVM device
      ansible.builtin.stat:
        path: /dev/kvm
      register: stat_kvm

    - name: Set a fact containing the virtualisation engine
      ansible.builtin.set_fact:
        libvirt_vm_engine: >-
          {%- if ansible_facts.architecture != libvirt_vm_arch -%}
          {# Virtualisation instructions are generally available only for the host
          architecture. Ideally we would test for virtualisation instructions, eg. vt-d
          as it is possible that another architecture could support these even
          if the emulated cpu architecture is not the same. #}
          qemu
          {%- elif stat_kvm.stat.exists -%}
          kvm
          {%- else -%}
          qemu
          {%- endif -%}
  rescue:
    - name: Fall back to QEMU if KVM detection fails
      ansible.builtin.set_fact:
        libvirt_vm_engine: qemu

- name: Detect the virtualisation emulator
  when: libvirt_vm_emulator is none or libvirt_vm_emulator | length == 0
  block:
    - name: Detect the KVM emulator binary path
      ansible.builtin.stat:
        path: "{{ item }}"
      register: kvm_emulator_result
      with_items:
        - /usr/bin/kvm
        - /usr/bin/qemu-kvm
        - /usr/libexec/qemu-kvm
      when: libvirt_vm_engine == 'kvm'

    - name: Set a fact containing the KVM emulator binary path
      ansible.builtin.set_fact:
        libvirt_vm_emulator: "{{ item.item }}"
      with_items: "{{ kvm_emulator_result.results }}"
      when:
        - libvirt_vm_engine == 'kvm'
        - kvm_emulator_result.results is defined
        - item.stat.exists

    - name: Detect the QEMU emulator binary path (RedHat)
      ansible.builtin.stat:
        path: /usr/libexec/qemu-kvm
      register: qemu_emulator_redhat_result
      when:
        - libvirt_vm_engine == 'qemu'
        - ansible_facts.os_family == 'RedHat'
        - ansible_facts.distribution_major_version | int >= 8

    - name: Set a fact containing the QEMU emulator binary path (RedHat)
      ansible.builtin.set_fact:
        libvirt_vm_emulator: "{{ qemu_emulator_redhat_result.stat.path }}"
      when:
        - libvirt_vm_engine == 'qemu'
        - ansible_facts.os_family == 'RedHat'
        - ansible_facts.distribution_major_version | int >= 8
        - qemu_emulator_redhat_result.stat.exists | default(false)

    - name: Detect the QEMU emulator binary path (non-RedHat)
      ansible.builtin.command:
        cmd: which qemu-system-{{ libvirt_vm_arch }}
      register: qemu_emulator_result
      changed_when: false
      failed_when: false
      when:
        - libvirt_vm_engine == 'qemu'
        - ansible_facts.os_family != 'RedHat' or ansible_facts.distribution_major_version | int == 7

    - name: Set a fact containing the QEMU emulator binary path (non-RedHat)
      ansible.builtin.set_fact:
        libvirt_vm_emulator: "{{ qemu_emulator_result.stdout }}"
      when:
        - libvirt_vm_engine == 'qemu'
        - ansible_facts.os_family != 'RedHat' or ansible_facts.distribution_major_version | int == 7
        - qemu_emulator_result.rc == 0

    - name: Fail if unable to detect the emulator
      ansible.builtin.fail:
        msg: Unable to detect emulator for engine {{ libvirt_vm_engine }}.
      when: libvirt_vm_emulator is none or libvirt_vm_emulator | length == 0
  rescue:
    - name: Emulator detection failed
      ansible.builtin.fail:
        msg: "Failed to detect virtualisation emulator. Please set libvirt_vm_emulator manually."
